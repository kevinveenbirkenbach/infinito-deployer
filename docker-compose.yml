version: "3.9"

services:
  # ---------------------------------------------------------
  # Catalog generator (writes roles/list.json into STATE_DIR)
  # ---------------------------------------------------------
  catalog:
    image: ${INFINITO_NEXUS_IMAGE}
    container_name: infinito-deployer-catalog

    env_file:
      - .env

    environment:
      INFINITO_REPO_PATH: ${INFINITO_REPO_PATH}
      STATE_DIR: ${STATE_DIR}
      CATALOG_DIR: ${CATALOG_DIR}

    volumes:
      - infinito_repo:${INFINITO_REPO_PATH}
      - ${STATE_HOST_PATH}:${STATE_DIR}

    entrypoint: ["sh", "-lc"]
    command:
      - |
        set -euo pipefail
        mkdir -p "${CATALOG_DIR}/roles"
        repo_src="${INFINITO_SRC_DIR:-/opt/src/infinito}"
        repo_dst="${INFINITO_REPO_PATH}"
        if [ ! -d "$${repo_dst}/roles" ] || [ -z "$$(find "$${repo_dst}/roles" -mindepth 1 -maxdepth 1 -print -quit 2>/dev/null)" ]; then
          echo "→ Seeding repo from $${repo_src} into $${repo_dst}"
          mkdir -p "$${repo_dst}"
          cp -a "$${repo_src}/." "$${repo_dst}/"
        fi
        if ! python3 -c "import yaml" >/dev/null 2>&1; then
          export DEBIAN_FRONTEND=noninteractive
          apt-get update -qq
          apt-get install -y --no-install-recommends python3-yaml >/dev/null
        fi
        cd "$${repo_dst}"
        echo "→ Generating invokable roles list into ${CATALOG_DIR}/roles/list.json"
        PYTHONPATH="$${repo_dst}" python3 -m cli.meta.applications.invokable --format json \
          > "${CATALOG_DIR}/roles/list.json"
        echo "✔ Catalog generated."
        tail -f /dev/null

    healthcheck:
      test:
        - CMD-SHELL
        - test -s "${CATALOG_DIR}/roles/list.json"
      interval: 15s
      timeout: 3s
      retries: 5
      start_period: 5s

    restart: ${RESTART_POLICY}

  # ---------------------------------------------------------
  # API
  # ---------------------------------------------------------
  api:
    build:
      context: ${API_BUILD_CONTEXT}
      dockerfile: ${API_DOCKERFILE}

    container_name: ${API_CONTAINER_NAME}

    env_file:
      - .env

    environment:
      INFINITO_REPO_PATH: ${INFINITO_REPO_PATH}
      STATE_DIR: ${STATE_DIR}
      STATE_HOST_PATH: ${STATE_HOST_PATH}

      APP_ENV: ${APP_ENV}
      APP_HOST: ${API_APP_HOST}
      APP_PORT: ${API_APP_PORT}

      CORS_ALLOW_ORIGINS: ${CORS_ALLOW_ORIGINS}

      ROLE_CATALOG_LIST_JSON: ${ROLE_CATALOG_LIST_JSON}
      ROLE_CATALOG_CATEGORIES_YML: ${ROLE_CATALOG_CATEGORIES_YML}

      # Job runner backend selection
      JOB_RUNNER_BACKEND: ${JOB_RUNNER_BACKEND}
      JOB_RUNNER_IMAGE: ${JOB_RUNNER_IMAGE}
      JOB_RUNNER_REPO_DIR: ${JOB_RUNNER_REPO_DIR}
      JOB_RUNNER_WORKDIR: ${JOB_RUNNER_WORKDIR}
      JOB_RUNNER_REPO_HOST_PATH: ${JOB_RUNNER_REPO_HOST_PATH}
      JOB_RUNNER_DOCKER_ARGS: ${JOB_RUNNER_DOCKER_ARGS}
      JOB_RUNNER_SKIP_CLEANUP: ${JOB_RUNNER_SKIP_CLEANUP}
      JOB_RUNNER_SKIP_BUILD: ${JOB_RUNNER_SKIP_BUILD}
      DOCKER_NETWORK_NAME: ${DOCKER_NETWORK_NAME}

    volumes:
      - infinito_repo:${INFINITO_REPO_PATH}:ro
      - ${STATE_HOST_PATH}:${STATE_DIR}

      # Required when JOB_RUNNER_BACKEND=container
      - ${DOCKER_SOCKET_PATH}:/var/run/docker.sock

    ports:
      - "${API_PORT}:${API_APP_PORT}"

    depends_on:
      catalog:
        condition: service_started

    healthcheck:
      test:
        - CMD
        - python
        - -c
        - >
          import os,urllib.request;
          p=os.environ.get("API_APP_PORT","8000");
          urllib.request.urlopen(f"http://127.0.0.1:{p}/health", timeout=2).read();
          print("ok")
      interval: ${API_HEALTHCHECK_INTERVAL}
      timeout: ${API_HEALTHCHECK_TIMEOUT}
      retries: ${API_HEALTHCHECK_RETRIES}



    restart: ${RESTART_POLICY}

  # ---------------------------------------------------------
  # Web
  # ---------------------------------------------------------
  web:
    build:
      context: ${WEB_BUILD_CONTEXT}
      dockerfile: ${WEB_DOCKERFILE}

    container_name: ${WEB_CONTAINER_NAME}

    env_file:
      - .env

    environment:
      NODE_ENV: ${NODE_ENV}
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL}
      API_PROXY_TARGET: ${API_PROXY_TARGET:-http://api:8000}

    ports:
      - "${WEB_PORT}:3000"

    depends_on:
      api:
        condition: service_healthy

    restart: ${RESTART_POLICY}

  # ---------------------------------------------------------
  # Test target (Arch Linux via SSH)
  # ---------------------------------------------------------
  test-arch:
    profiles: ["test"]
    build:
      context: ./apps/test/arch-ssh
      dockerfile: Dockerfile

    container_name: infinito-deployer-test-arch

    ports:
      - "${TEST_ARCH_SSH_PORT:-2224}:22"

    restart: ${RESTART_POLICY}

  # ---------------------------------------------------------
  # Test targets (password/key SSH)
  # ---------------------------------------------------------
  ssh-password:
    profiles: ["test"]
    build:
      context: ./apps/test/ssh-password
      dockerfile: Dockerfile

    container_name: infinito-deployer-ssh-password

    ports:
      - "${TEST_SSH_PASSWORD_PORT:-2222}:22"

    restart: ${RESTART_POLICY}

  ssh-key:
    profiles: ["test"]
    build:
      context: ./apps/test/ssh-key
      dockerfile: Dockerfile

    container_name: infinito-deployer-ssh-key

    ports:
      - "${TEST_SSH_KEY_PORT:-2223}:22"

    restart: ${RESTART_POLICY}

networks:
  default:
    name: ${DOCKER_NETWORK_NAME}

volumes:
  infinito_repo:
