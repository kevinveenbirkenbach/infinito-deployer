version: "3.9"

services:
  # ---------------------------------------------------------
  # Catalog generator (writes roles/list.json into STATE_DIR)
  # ---------------------------------------------------------
  catalog:
    image: ${INFINITO_NEXUS_IMAGE}
    container_name: infinito-deployer-catalog

    env_file:
      - .env

    environment:
      INFINITO_REPO_PATH: ${INFINITO_REPO_PATH}
      STATE_DIR: ${STATE_DIR}
      CATALOG_DIR: ${CATALOG_DIR}

    volumes:
      - infinito_repo:${INFINITO_REPO_PATH}
      - ${STATE_HOST_PATH}:${STATE_DIR}

    entrypoint: ["sh", "-lc"]
    command:
      - |
        set -euo pipefail
        mkdir -p "${CATALOG_DIR}/roles"
        repo_src="${INFINITO_SRC_DIR:-/opt/src/infinito}"
        repo_dst="${INFINITO_REPO_PATH}"
        if [ ! -d "$${repo_dst}/roles" ] || [ -z "$$(find "$${repo_dst}/roles" -mindepth 1 -maxdepth 1 -print -quit 2>/dev/null)" ]; then
          echo "→ Seeding repo from $${repo_src} into $${repo_dst}"
          mkdir -p "$${repo_dst}"
          cp -a "$${repo_src}/." "$${repo_dst}/"
        fi
        cd "$${repo_dst}"
        echo "→ Generating invokable roles list into ${CATALOG_DIR}/roles/list.json"
        infinito meta applications invokable \
          | python -c 'import sys, json; data=[l.strip() for l in sys.stdin if l.strip()]; print(json.dumps(data))' \
          > "${CATALOG_DIR}/roles/list.json"
        echo "✔ Catalog generated."
        tail -f /dev/null

    restart: ${RESTART_POLICY}

  # ---------------------------------------------------------
  # API
  # ---------------------------------------------------------
  api:
    build:
      context: ${API_BUILD_CONTEXT}
      dockerfile: ${API_DOCKERFILE}

    container_name: ${API_CONTAINER_NAME}

    env_file:
      - .env

    environment:
      INFINITO_REPO_PATH: ${INFINITO_REPO_PATH}
      STATE_DIR: ${STATE_DIR}

      APP_ENV: ${APP_ENV}
      APP_HOST: ${API_APP_HOST}
      APP_PORT: ${API_APP_PORT}

      CORS_ALLOW_ORIGINS: ${CORS_ALLOW_ORIGINS}

      ROLE_CATALOG_LIST_JSON: ${ROLE_CATALOG_LIST_JSON}
      ROLE_CATALOG_CATEGORIES_YML: ${ROLE_CATALOG_CATEGORIES_YML}

    volumes:
      - infinito_repo:${INFINITO_REPO_PATH}:ro
      - ${STATE_HOST_PATH}:${STATE_DIR}

      # Optional: enable only if you really need Docker access
      # - ${DOCKER_SOCKET_PATH}:/var/run/docker.sock

    ports:
      - "${API_PORT}:${API_APP_PORT}"

    depends_on:
      catalog:
        condition: service_started

    healthcheck:
      test:
        - CMD
        - python
        - -c
        - >
          import os,urllib.request;
          p=os.environ.get("API_APP_PORT","8000");
          urllib.request.urlopen(f"http://127.0.0.1:{p}/health", timeout=2).read();
          print("ok")
      interval: ${API_HEALTHCHECK_INTERVAL}
      timeout: ${API_HEALTHCHECK_TIMEOUT}
      retries: ${API_HEALTHCHECK_RETRIES}



    restart: ${RESTART_POLICY}

  # ---------------------------------------------------------
  # Web
  # ---------------------------------------------------------
  web:
    build:
      context: ${WEB_BUILD_CONTEXT}
      dockerfile: ${WEB_DOCKERFILE}

    container_name: ${WEB_CONTAINER_NAME}

    env_file:
      - .env

    environment:
      NODE_ENV: ${NODE_ENV}
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL}

    ports:
      - "${WEB_PORT}:3000"

    depends_on:
      api:
        condition: service_healthy

    restart: ${RESTART_POLICY}

networks:
  default:
    name: ${DOCKER_NETWORK_NAME}

volumes:
  infinito_repo:
